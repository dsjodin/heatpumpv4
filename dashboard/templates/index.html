<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ dashboard_title }} - WebSocket Test</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        #console {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 1rem;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
        }
        .console-line {
            margin-bottom: 0.25rem;
        }
        .console-success { color: #00ff00; }
        .console-error { color: #ff0000; }
        .console-info { color: #00bfff; }
        .console-warning { color: #ffaa00; }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üî• {{ brand_name }}</span>
            <span class="badge fs-6" id="connection-status">Ansluter...</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Test Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üß™ WebSocket Connection Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Connection Status</h6>
                                <p id="ws-status" class="lead">Connecting to server...</p>

                                <h6 class="mt-3">Actions</h6>
                                <button id="btn-ping" class="btn btn-primary me-2" disabled>Send Ping</button>
                                <button id="btn-update" class="btn btn-success me-2" disabled>Request Update</button>
                                <button id="btn-clear" class="btn btn-secondary">Clear Console</button>

                                <h6 class="mt-3">Time Range</h6>
                                <select id="time-range" class="form-select" disabled>
                                    <option value="1h">Senaste timme</option>
                                    <option value="6h">Senaste 6 timmar</option>
                                    <option value="24h" selected>Senaste 24 timmar</option>
                                    <option value="7d">Senaste vecka</option>
                                    <option value="30d">Senaste m√•nad</option>
                                </select>

                                <div class="mt-3">
                                    <h6>Statistics</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Connected:</td>
                                            <td id="stat-connected">--</td>
                                        </tr>
                                        <tr>
                                            <td>Updates Received:</td>
                                            <td id="stat-updates">0</td>
                                        </tr>
                                        <tr>
                                            <td>Pings Sent:</td>
                                            <td id="stat-pings">0</td>
                                        </tr>
                                        <tr>
                                            <td>Last Update:</td>
                                            <td id="stat-last-update">Never</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Console Output</h6>
                                <div id="console"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Preview Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">COP Chart Preview</div>
                    <div class="card-body">
                        <div id="cop-chart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Runtime Pie Chart Preview</div>
                    <div class="card-body">
                        <div id="runtime-chart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Statistics
        let stats = {
            updates: 0,
            pings: 0,
            connectedAt: null
        };

        // Console logging
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            const timestamp = new Date().toLocaleTimeString('sv-SE');
            line.textContent = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        // Update statistics display
        function updateStats() {
            document.getElementById('stat-updates').textContent = stats.updates;
            document.getElementById('stat-pings').textContent = stats.pings;

            if (stats.connectedAt) {
                const duration = Math.floor((Date.now() - stats.connectedAt) / 1000);
                document.getElementById('stat-connected').textContent = `${duration}s`;
            }
        }

        // Connect to WebSocket server
        log('Initializing Socket.IO client...', 'info');
        const socket = io('http://localhost:8050', {
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 10
        });

        // Initialize ECharts
        const copChart = echarts.init(document.getElementById('cop-chart'));
        const runtimeChart = echarts.init(document.getElementById('runtime-chart'));

        // Connection handlers
        socket.on('connect', () => {
            log('‚úÖ WebSocket connected successfully!', 'success');
            stats.connectedAt = Date.now();

            // Update UI
            document.getElementById('ws-status').innerHTML =
                '<span class="text-success">‚úÖ Connected to server</span>';
            document.getElementById('connection-status').className = 'badge fs-6 status-connected';
            document.getElementById('connection-status').textContent = 'Ansluten';

            // Enable buttons
            document.getElementById('btn-ping').disabled = false;
            document.getElementById('btn-update').disabled = false;
            document.getElementById('time-range').disabled = false;

            // Load initial data
            log('üì• Loading initial data...', 'info');
            loadInitialData();
        });

        socket.on('disconnect', () => {
            log('‚ùå WebSocket disconnected', 'error');
            stats.connectedAt = null;

            document.getElementById('ws-status').innerHTML =
                '<span class="text-danger">‚ùå Disconnected from server</span>';
            document.getElementById('connection-status').className = 'badge fs-6 status-disconnected';
            document.getElementById('connection-status').textContent = 'Fr√•nkopplad';

            // Disable buttons
            document.getElementById('btn-ping').disabled = true;
            document.getElementById('btn-update').disabled = true;
            document.getElementById('time-range').disabled = true;
        });

        socket.on('connect_error', (error) => {
            log(`‚ö†Ô∏è Connection error: ${error.message}`, 'error');
        });

        socket.on('connection_status', (data) => {
            log(`üì° ${data.message}`, 'info');
        });

        socket.on('pong', (data) => {
            log(`üèì Pong received! Timestamp: ${data.timestamp}`, 'success');
        });

        socket.on('graph_update', (data) => {
            stats.updates++;
            log(`üìä Graph update received (${stats.updates})`, 'success');
            document.getElementById('stat-last-update').textContent =
                new Date().toLocaleTimeString('sv-SE');

            updateCharts(data);
        });

        socket.on('error', (data) => {
            log(`‚ùå Server error: ${data.message}`, 'error');
        });

        // Load initial data via HTTP
        async function loadInitialData() {
            try {
                const timeRange = document.getElementById('time-range').value;
                const response = await fetch(`/api/initial-data?range=${timeRange}`);
                const data = await response.json();

                log(`‚úÖ Initial data loaded for range: ${timeRange}`, 'success');
                log(`   - COP points: ${data.cop.values.length}`, 'info');
                log(`   - Temperature metrics: ${Object.keys(data.temperature).length - 1}`, 'info');

                updateCharts(data);

            } catch (error) {
                log(`‚ùå Failed to load initial data: ${error.message}`, 'error');
            }
        }

        // Update charts with data
        function updateCharts(data) {
            // Update COP chart
            if (data.cop && data.cop.values.length > 0) {
                const copOption = {
                    grid: { left: 50, right: 30, top: 30, bottom: 40 },
                    xAxis: {
                        type: 'time',
                        axisLabel: { fontSize: 10 }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'COP',
                        min: 0,
                        max: 6
                    },
                    series: [{
                        type: 'line',
                        data: data.cop.timestamps.map((t, i) => [t, data.cop.values[i]]),
                        smooth: true,
                        lineStyle: { color: '#4CAF50', width: 2 },
                        areaStyle: { color: 'rgba(76, 175, 80, 0.2)' },
                        markLine: {
                            silent: false,
                            lineStyle: { type: 'dashed', color: '#ff9800' },
                            data: [{
                                yAxis: data.cop.avg,
                                label: { formatter: `Medel: ${data.cop.avg.toFixed(2)}` }
                            }]
                        }
                    }],
                    tooltip: { trigger: 'axis' }
                };
                copChart.setOption(copOption, true);
                log(`üìà COP chart updated (avg: ${data.cop.avg.toFixed(2)})`, 'success');
            }

            // Update runtime chart
            if (data.runtime) {
                const runtimeOption = {
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        data: [
                            {
                                value: data.runtime.compressor_percent,
                                name: 'Kompressor',
                                itemStyle: { color: '#4caf50' }
                            },
                            {
                                value: data.runtime.aux_heater_percent,
                                name: 'Tillsats',
                                itemStyle: { color: '#ffc107' }
                            },
                            {
                                value: data.runtime.inactive_percent,
                                name: 'Inaktiv',
                                itemStyle: { color: '#e9ecef' }
                            }
                        ],
                        label: { formatter: '{b}: {d}%' }
                    }]
                };
                runtimeChart.setOption(runtimeOption, true);
                log(`ü•ß Runtime pie chart updated`, 'success');
            }
        }

        // Button handlers
        document.getElementById('btn-ping').addEventListener('click', () => {
            stats.pings++;
            socket.emit('ping');
            log(`üèì Ping sent (${stats.pings})`, 'info');
        });

        document.getElementById('btn-update').addEventListener('click', () => {
            const timeRange = document.getElementById('time-range').value;
            socket.emit('request_update', { range: timeRange });
            log(`üîÑ Manual update requested for range: ${timeRange}`, 'info');
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
            document.getElementById('console').innerHTML = '';
            log('Console cleared', 'info');
        });

        document.getElementById('time-range').addEventListener('change', (e) => {
            const timeRange = e.target.value;
            socket.emit('change_time_range', { range: timeRange });
            log(`‚è±Ô∏è Time range changed to: ${timeRange}`, 'info');
        });

        // Update stats every second
        setInterval(updateStats, 1000);

        // Make charts responsive
        window.addEventListener('resize', () => {
            copChart.resize();
            runtimeChart.resize();
        });

        // Initial log
        log('üöÄ Dashboard initialized', 'success');
        log('üì° Waiting for WebSocket connection...', 'info');
    </script>
</body>
</html>
