# Docker Compose for Heat Pump Dashboard - WebSocket Version
# Flask + Socket.IO + ECharts implementation

version: '3.8'

services:
  # InfluxDB Time-Series Database
  influxdb:
    image: influxdb:2.7
    container_name: heatpump-influxdb
    ports:
      - "8087:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUX_USERNAME:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUX_PASSWORD:-changeme123}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-thermia}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-heatpump}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
    restart: unless-stopped
    networks:
      - heatpump-network

  # Data Collector Service - API Only (Perfect Timestamp Sync!)
  collector:
    build:
      context: .
      dockerfile: collector/Dockerfile
    container_name: heatpump-collector
    restart: unless-stopped
    depends_on:
      - influxdb
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    environment:
      # H66 API Configuration
      - H66_IP=${H66_IP:-192.168.1.100}
      - COLLECTION_INTERVAL=${COLLECTION_INTERVAL:-30}
      - HEATPUMP_BRAND=${HEATPUMP_BRAND:-thermia}
      # InfluxDB Configuration
      - INFLUXDB_URL=http://influxdb:8087
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-thermia}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-heatpump}
    networks:
      - heatpump-network

  # WebSocket Dashboard (Flask + Socket.IO + ECharts)
  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: heatpump-dashboard-websocket
    ports:
      - "8051:8051"
    environment:
      - INFLUXDB_URL=http://influxdb:8087
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-thermia}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-heatpump}
      - HEATPUMP_BRAND=${HEATPUMP_BRAND:-thermia}
      - SECRET_KEY=${SECRET_KEY:-heatpump-dashboard-secret-key-change-in-production}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    depends_on:
      - influxdb
    restart: unless-stopped
    networks:
      - heatpump-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8050/api/config', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  heatpump-network:
    driver: bridge

volumes:
  influxdb-data:
  influxdb-config:
